<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archangels MC - Mapa</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; background: #111; color: #fff; }
    #sidebar {
      position: fixed; top: 0; left: 0; bottom: 0; width: 280px;
      background: #1a1a1a; padding: 20px; overflow-y: auto;
      z-index: 10; border-right: 2px solid #222;
    }
    #sidebar img { display: block; margin: 0 auto 10px; max-width: 100px; }
    #sidebar h1 {
      text-align: center; font-size: 26px;
      font-weight: bold; color: red;
      text-shadow: 0 0 10px red; letter-spacing: 2px;
      margin-bottom: 10px;
    }
    #controls input, #controls button {
      width: 100%; margin-bottom: 5px; padding: 8px;
      background: #333; color: white; border: none; text-align: left;
      transition: background 0.2s, cursor 0.2s;
    }
    #controls button:hover {
      cursor: pointer;
      background: #444;
    }
    .category-header {
      width: 100%; margin-bottom: 5px; padding: 8px;
      background: #333; color: white; border: none;
      font-weight: 900; font-size: 16px; cursor: pointer;
    }
    .category-items { margin-left: 10px; }
    .item {
      display: flex; justify-content: space-between;
      align-items: center; font-size: 14px;
      margin: 5px 0; cursor: pointer;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; }
    .delete-btn { color: #888; font-size: 12px; cursor: pointer; }
    #map {
      position: absolute; left: 280px; top: 0; right: 0; bottom: 0;
      background: #000 url('mapa.png') no-repeat center center;
      background-size: contain; cursor: grab;
      overflow: hidden; transform-origin: 0 0;
    }
    .marker {
      position: absolute; border-radius: 50%;
      border: 1px solid white; transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .polygon-point {
      position: absolute; width: 8px; height: 8px;
      background: cyan; border: 1px solid white;
      border-radius: 50%; transform: translate(-50%, -50%);
    }
    svg.polygon { position: absolute; top: 0; left: 0; pointer-events: none; }
    .tooltip {
      position: absolute; background: rgba(0,0,0,0.8); color: white;
      padding: 4px 8px; font-size: 12px; border-radius: 4px;
      pointer-events: none; z-index: 99; display: none;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <img src="logo.png" alt="Archangels MC logo">
    <h1>Archangels MC</h1>
    <div id="controls">
      <input type="text" id="search" placeholder="üîç Hledat..." oninput="render()">
      <button id="show-all">Zobrazit v≈°e</button>
      <button onclick="togglePlanningMode()">üìù Pl√°novat</button>
    </div>
    <div style="height: 20px;"></div>
    <div id="menu"></div>
  </div>
  <div id="map"></div>
  <div id="tooltip" class="tooltip"></div>
  <script>
    let data = JSON.parse(localStorage.getItem("mapData")) || [];
    let planningMode = false;
    let currentPolygon = [];
    let filter = "all";
    let isDragging = false;
    let start = { x: 0, y: 0 };
    let originX = 0, originY = 0, scale = 1;
    const tooltip = document.getElementById("tooltip");
    const map = document.getElementById("map");
    const menu = document.getElementById("menu");
    const categoryVisibility = {};

    function save() {
      if (!planningMode) localStorage.setItem("mapData", JSON.stringify(data));
    }

    function setFilter(type) {
      filter = type;
      render();
    }

    function togglePlanningMode() {
      planningMode = !planningMode;
      alert(`Pl√°novac√≠ re≈æim: ${planningMode ? 'ZAPNUT√ù' : 'VYPNUT√ù'}`);
    }

    function deleteItem(id) {
      data = data.filter(i => i.id !== id);
      save();
      render();
    }

    function render() {
      menu.innerHTML = "";
      map.querySelectorAll(".marker, .polygon-point, svg.polygon").forEach(el => el.remove());
      const cats = [
        "üìç Lokace", "üó∫Ô∏è √özem√≠", "üî´ P≈ôed√°n√≠ zbran√≠",
        "üöó Uj√≠≈ædƒõn√≠ autem", "üèçÔ∏è Uj√≠≈ædƒõn√≠ na motorce",
        "üèÉ‚Äç‚ôÇÔ∏è √ötƒõk pƒõ≈°ky", "üì¶ Sklady", "ü•∑ M√≠sta na v√Ωslech"
      ];
      const search = document.getElementById("search").value.toLowerCase();

      for (let cat of cats) {
        if (!(cat in categoryVisibility)) categoryVisibility[cat] = true;

        const header = document.createElement("button");
        header.className = "category-header";
        header.textContent = `${cat} (${data.filter(i => i.categories?.includes(cat)).length})`;
        const items = document.createElement("div");
        items.className = "category-items";
        items.style.display = categoryVisibility[cat] ? "block" : "none";

        header.onclick = () => {
          categoryVisibility[cat] = !categoryVisibility[cat];
          render();
        };

        if (categoryVisibility[cat]) {
          data.forEach(item => {
            const inSearch = item.name?.toLowerCase().includes(search);
            if (
              item.categories.includes(cat) &&
              (filter === 'all' || item.categories.includes(filter)) &&
              (!search || inSearch)
            ) {
              item.type === 'point' && renderMarker(item);
              item.type === 'polygon' && renderPolygon(item);
              const div = document.createElement("div");
              div.className = "item";
              div.innerHTML = `<div><span class="dot" style="background:${item.color}"></span>${item.name}</div><span class="delete-btn" onclick="deleteItem(${item.id}); event.stopPropagation()">üóë</span>`;
              items.appendChild(div);
            }
          });
        }

        menu.appendChild(header);
        menu.appendChild(items);
      }
    }

    function renderMarker(item) {
      const el = document.createElement("div");
      el.className = "marker";
      el.style.left = `${item.x * 100}%`;
      el.style.top = `${item.y * 100}%`;
      el.style.background = item.color;
      el.style.width = el.style.height = `${item.size || 6}px`;
      el.title = item.desc;
      el.onmouseenter = e => showTooltip(e, item.name + ": " + item.desc);
      el.onmouseleave = hideTooltip;
      map.appendChild(el);
    }

    function renderPolygon(item) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.classList.add("polygon");
      svg.setAttribute("width", map.clientWidth);
      svg.setAttribute("height", map.clientHeight);
      const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      poly.setAttribute("points", item.points.map(p => `${p.x * map.clientWidth},${p.y * map.clientHeight}`).join(" "));
      poly.setAttribute("fill", item.color + "55");
      poly.setAttribute("stroke", item.color);
      poly.onmouseenter = e => showTooltip(e, item.name + ": " + item.desc);
      poly.onmouseleave = hideTooltip;
      svg.appendChild(poly);
      map.appendChild(svg);
    }

    function showTooltip(e, text) {
      tooltip.style.display = "block";
      tooltip.style.left = e.clientX + 10 + "px";
      tooltip.style.top = e.clientY + 10 + "px";
      tooltip.textContent = text;
    }

    function hideTooltip() { tooltip.style.display = "none"; }

    map.addEventListener("dblclick", e => {
      if (e.shiftKey) return;
      const r = map.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width;
      const y = (e.clientY - r.top) / r.height;
      openForm("point", { x, y });
    });

    map.addEventListener("click", e => {
      if (!e.shiftKey) return;
      const r = map.getBoundingClientRect();
      const x = (e.clientX - r.left) / r.width;
      const y = (e.clientY - r.top) / r.height;
      currentPolygon.push({ x, y });
      const point = document.createElement("div");
      point.className = "polygon-point";
      point.style.left = `${x * 100}%`;
      point.style.top = `${y * 100}%`;
      map.appendChild(point);
      if (currentPolygon.length > 2 && confirm("Uzav≈ô√≠t √∫zem√≠?")) {
        openForm("polygon", currentPolygon);
        currentPolygon = [];
        document.querySelectorAll(".polygon-point").forEach(el => el.remove());
      }
    });

    map.addEventListener("wheel", e => {
      e.preventDefault();
      const rect = map.getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / scale;
      const mouseY = (e.clientY - rect.top) / scale;
      scale += e.deltaY * -0.002;
      scale = Math.min(Math.max(0.5, scale), 6);
      originX -= (mouseX * e.deltaY * -0.002);
      originY -= (mouseY * e.deltaY * -0.002);
      map.style.transform = `scale(${scale}) translate(${originX}px, ${originY}px)`;
    }, { passive: false });

    map.addEventListener("mousedown", e => { isDragging = true; start = { x: e.clientX, y: e.clientY }; });
    window.addEventListener("mouseup", () => isDragging = false);
    window.addEventListener("mousemove", e => {
      if (!isDragging) return;
      originX += (e.clientX - start.x) / scale;
      originY += (e.clientY - start.y) / scale;
      start = { x: e.clientX, y: e.clientY };
      map.style.transform = `scale(${scale}) translate(${originX}px, ${originY}px)`;
    });

    document.getElementById("show-all").onclick = () => {
      for (let key in categoryVisibility) categoryVisibility[key] = true;
      render();
    };

    function openForm(type, coords) {
      const wrapper = document.createElement("div");
      wrapper.style.position = "fixed";
      wrapper.style.top = "50%";
      wrapper.style.left = "50%";
      wrapper.style.transform = "translate(-50%, -50%)";
      wrapper.style.background = "#222";
      wrapper.style.padding = "20px";
      wrapper.style.border = "1px solid #555";
      wrapper.style.zIndex = "999";
      wrapper.style.color = "white";
      wrapper.innerHTML = `
        <label>N√°zev:<br><input id='form-name' style='width:100%'></label><br><br>
        <label>Popis:<br><textarea id='form-desc' style='width:100%'></textarea></label><br><br>
        <label>Barva:<br><input type='color' id='form-color' value='#00ffff'></label><br><br>
        <label>Velikost:<br><input type='number' id='form-size' value='6' min='1' max='20'></label><br><br>
        <div><b>Za≈ôadit do kategori√≠:</b><br>` +
        ["üìç Lokace", "üó∫Ô∏è √özem√≠", "üî´ P≈ôed√°n√≠ zbran√≠", "üöó Uj√≠≈ædƒõn√≠ autem", "üèçÔ∏è Uj√≠≈ædƒõn√≠ na motorce", "üèÉ‚Äç‚ôÇÔ∏è √ötƒõk pƒõ≈°ky", "üì¶ Sklady", "ü•∑ M√≠sta na v√Ωslech"]
          .map(c => `<label><input type='checkbox' value='${c}'> ${c}</label><br>`).join('') +
        `<br><button id='form-ok'>OK</button> <button id='form-cancel'>Zru≈°it</button>`;

      document.body.appendChild(wrapper);

      document.getElementById("form-ok").onclick = () => {
        const name = document.getElementById("form-name").value;
        const desc = document.getElementById("form-desc").value;
        const color = document.getElementById("form-color").value;
        const size = +document.getElementById("form-size").value;
        const selectedCats = Array.from(wrapper.querySelectorAll("input[type=checkbox]:checked")).map(i => i.value);
        if (!name || selectedCats.length === 0) return alert("Vypl≈à n√°zev a vyber aspo≈à jednu kategorii.");
        const item = { id: Date.now(), type, name, desc, color, size, categories: selectedCats };
        if (type === "point") { item.x = coords.x; item.y = coords.y; } else { item.points = [...coords]; }
        data.push(item);
        save();
        render();
        document.body.removeChild(wrapper);
      };

      document.getElementById("form-cancel").onclick = () => {
        document.body.removeChild(wrapper);
      };
    }

    window.onload = () => render();
  </script>
</body>
</html>
