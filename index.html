<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archangels MC - Mapa</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; background: #111; color: #fff; }
    #sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #1a1a1a; padding: 20px; overflow-y: auto; z-index: 10; border-right: 2px solid #222; }
    #sidebar img { display: block; margin: 0 auto 10px; max-width: 100px; }
    #sidebar h1 { text-align: center; font-size: 20px; color: #ff5050; margin-bottom: 10px; }
    #controls input, #controls button, .category-header { width: 100%; margin-bottom: 5px; padding: 8px; background: #222; color: white; border: none; cursor: pointer; text-align: left; }
    #controls input { background: #333; border-radius: 4px; cursor: text; }
    .category-items { margin-left: 10px; }
    .item { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin: 5px 0; cursor: pointer; }
    .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; }
    .delete-btn { color: #888; font-size: 12px; cursor: pointer; }
    #map { position: absolute; left: 280px; top: 0; right: 0; bottom: 0; background: #000 url('mapa.png') no-repeat center center; background-size: contain; cursor: grab; overflow: hidden; }
    .marker { position: absolute; border-radius: 50%; border: 1px solid white; transform: translate(-50%, -50%); cursor: pointer; }
    .polygon-point { position: absolute; width: 8px; height: 8px; background: cyan; border: 1px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
    svg.polygon { position: absolute; top: 0; left: 0; pointer-events: none; }
    .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px; pointer-events: none; z-index: 99; display: none; }
    #context-menu { position: absolute; background: #222; color: white; border: 1px solid #555; padding: 5px; display: none; z-index: 100; font-size: 13px; }
    #context-menu div { padding: 4px 8px; cursor: pointer; }
    #context-menu div:hover { background: #444; }
  </style>
</head>
<body>
  <div id="sidebar">
    <img src="logo.png" alt="Archangels MC logo">
    <h1>Archangels MC</h1>
    <div id="controls">
      <input type="text" id="search" placeholder="游댌 Hledat..." oninput="render()">
      <button onclick="setFilter('all')">Zobrazit v코e</button>
      <button onclick="setFilter('point')">Jen body</button>
      <button onclick="setFilter('polygon')">Jen 칰zem칤</button>
      <button onclick="togglePlanningMode()">游닇 Pl치novat</button>
    </div>
    <div style="height: 20px;"></div>
    <div id="menu"></div>
  </div>
  <div id="map"></div>
  <div id="tooltip" class="tooltip"></div>
  <div id="context-menu"></div>
  <script>
    // Kompletn칤 JS k칩d vlo쬰n sem
localStorage.removeItem("mapData");
let data = [];
let planningMode = false;
let currentPolygon = [];
let filter = "all";
let tooltip = document.getElementById("tooltip");
const map = document.getElementById("map");
const menu = document.getElementById("menu");

function save() {
  if (!planningMode) localStorage.setItem("mapData", JSON.stringify(data));
}

function setFilter(type) { filter = type; render(); }
function togglePlanningMode() {
  planningMode = !planningMode;
  alert(`Pl치novac칤 re쬴m: ${planningMode ? 'ZAPNUT칗' : 'VYPNUT칗'}`);
}

function render() {
  menu.innerHTML = "";
  const searchValue = document.getElementById("search")?.value.toLowerCase() || "";
  map.querySelectorAll(".marker, .polygon-point, svg.polygon").forEach(el => el.remove());
  const cats = { "Lokace": [], "칔zem칤": [], "Dod치vky": [], "Uj칤쬯캩n칤 autem": [], "Uj칤쬯캩n칤 na motorce": [], "칔t캩k p캩코ky": [], "Sklady": [] };
  for (let cat in cats) {
    const wrap = document.createElement("div"), h2 = document.createElement("button");
    const count = data.filter(i => i.categories?.includes(cat)).length;
    h2.textContent = `${cat} (${count})`;
    h2.className = "category-header";
    h2.onclick = () => items.style.display = items.style.display === "block" ? "none" : "block";
    const items = document.createElement("div"); items.className = "category-items";
    data.forEach(item => {
      if ((filter === "all" || filter === item.type) && item.categories?.includes(cat)) {
        if (!item.name || !item.name.toLowerCase().includes(searchValue)) return;
        item.type === "point" && renderMarker(item);
        item.type === "polygon" && renderPolygon(item);
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div><span class="dot" style="background:${item.color}"></span>${item.name}</div><span class="delete-btn" onclick="deleteItem(${item.id}); event.stopPropagation()">游딈</span>`;
        div.onclick = () => {
          centerTo(item);
          scale = 4;
          map.style.transform = `scale(${scale}) translate(${originX}px, ${originY}px)`;
        };
        items.appendChild(div);
      }
    });
    wrap.appendChild(h2); wrap.appendChild(items); menu.appendChild(wrap);
  }
}

function renderMarker(item) {
  const el = document.createElement("div");
  el.className = "marker";
  el.style.left = `${item.x * 100}%`;
  el.style.top = `${item.y * 100}%`;
  el.style.background = item.color;
  el.style.width = el.style.height = `${item.size || 4}px`;
  el.title = item.desc;
  el.addEventListener("contextmenu", e => openContextMenu(e, item));
  el.onmouseenter = e => showTooltip(e, item.desc);
  el.onmouseleave = hideTooltip;
  map.appendChild(el);
}

function renderPolygon(item) {
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.classList.add("polygon");
  svg.setAttribute("width", map.clientWidth);
  svg.setAttribute("height", map.clientHeight);
  const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
  poly.setAttribute("points", item.points.map(p => `${p.x * map.clientWidth},${p.y * map.clientHeight}`).join(" "));
  poly.setAttribute("fill", item.color + "55");
  poly.setAttribute("stroke", item.color);
  poly.onmouseenter = e => showTooltip(e, item.desc);
  poly.onmouseleave = hideTooltip;
  poly.addEventListener("contextmenu", e => openContextMenu(e, item));
  svg.appendChild(poly);
  map.appendChild(svg);
}

function showTooltip(e, text) {
  tooltip.style.display = "block";
  tooltip.style.left = e.clientX + 10 + "px";
  tooltip.style.top = e.clientY + 10 + "px";
  tooltip.textContent = text;
}
function hideTooltip() { tooltip.style.display = "none"; }

function openContextMenu(e, item) {
  e.preventDefault();
  const menu = document.getElementById("context-menu");
  menu.innerHTML = `
    <div onclick="deleteItem(${item.id})">游딈 Smazat</div>
    <div onclick="editItem(${item.id})">九勇 Upravit</div>`;
  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.style.display = "block";
  window.addEventListener("click", () => menu.style.display = "none", { once: true });
}

function editItem(id) {
  const item = data.find(i => i.id === id);
  if (!item) return;
  item.name = prompt("N치zev:", item.name);
  item.desc = prompt("Popis:", item.desc);
  item.color = prompt("Barva:", item.color);
  item.size = +prompt("Velikost: (nap콏. 4)", item.size);
  save(); render();
}

function centerTo(item) {
  const x = item.type === "point" ? item.x : item.points.reduce((a, b) => a + b.x, 0) / item.points.length;
  const y = item.type === "point" ? item.y : item.points.reduce((a, b) => a + b.y, 0) / item.points.length;
  map.scrollTo({ left: x * map.scrollWidth - map.clientWidth / 2, top: y * map.scrollHeight - map.clientHeight / 2, behavior: "smooth" });
}

function deleteItem(id) {
  data = data.filter(i => i.id !== id);
  save(); render();
}

function openForm(type, coords) {
  const wrapper = document.createElement("div");
  wrapper.style.position = "fixed";
  wrapper.style.top = "50%";
  wrapper.style.left = "50%";
  wrapper.style.transform = "translate(-50%, -50%)";
  wrapper.style.background = "#222";
  wrapper.style.padding = "20px";
  wrapper.style.border = "1px solid #555";
  wrapper.style.zIndex = "999";

  wrapper.innerHTML = `
    <label>N치zev:<br><input id='form-name' style='width:100%'></label><br><br>
    <label>Popis:<br><textarea id='form-desc' style='width:100%'></textarea></label><br><br>
    <label>Barva:<br><input type='color' id='form-color' value='#00ffff'></label><br><br>
    <label>Velikost:<br><input type='number' id='form-size' value='4' min='1' max='20'></label><br><br>
    <div><b>Za콏adit do kategori칤:</b><br>` +
    ["Lokace", "칔zem칤", "Dod치vky", "Uj칤쬯캩n칤 autem", "Uj칤쬯캩n칤 na motorce", "칔t캩k p캩코ky", "Sklady"]
      .map(c => `<label><input type='checkbox' value='${c}' checked> ${c}</label><br>`).join("") +
    `</div><br><button id='form-ok'>OK</button>`;

  document.body.appendChild(wrapper);

  document.getElementById("form-ok").onclick = () => {
    const name = document.getElementById("form-name").value;
    const desc = document.getElementById("form-desc").value;
    const color = document.getElementById("form-color").value;
    const size = +document.getElementById("form-size").value;
    const selectedCats = Array.from(wrapper.querySelectorAll("input[type=checkbox]:checked")).map(i => i.value);

    if (!name) return alert("Zadej n치zev.");
    const item = { id: Date.now(), type, name, desc, color, size, categories: selectedCats };
    if (type === "point") { item.x = coords.x; item.y = coords.y; } else { item.points = [...coords]; }
    if (!planningMode) data.push(item);
    save(); render();
    document.body.removeChild(wrapper);
  };
  // odstran캩n star칳 color picker blok
  }, { once: true });
}

map.addEventListener("dblclick", e => {
  if (e.shiftKey) return;
  const r = map.getBoundingClientRect(), x = (e.clientX - r.left) / r.width, y = (e.clientY - r.top) / r.height;
  openForm("point", { x, y });
});

map.addEventListener("click", e => {
  if (!e.shiftKey) return;
  const r = map.getBoundingClientRect(), x = (e.clientX - r.left) / r.width, y = (e.clientY - r.top) / r.height;
  currentPolygon.push({ x, y });
  const point = document.createElement("div");
  point.className = "polygon-point";
  point.style.left = `${x * 100}%`;
  point.style.top = `${y * 100}%`;
  map.appendChild(point);
  if (currentPolygon.length > 2 && confirm("Uzav콏칤t 칰zem칤?")) {
    openForm("polygon", currentPolygon);
    currentPolygon = [];
    document.querySelectorAll(".polygon-point").forEach(el => el.remove());
  }
});

let scale = 1, originX = 0, originY = 0, isDragging = false, start = { x: 0, y: 0 };
map.addEventListener("wheel", e => {
  e.preventDefault();
  scale += e.deltaY * -0.001;
  scale = Math.min(Math.max(0.5, scale), 6);
  map.style.transform = `scale(${scale}) translate(${originX}px, ${originY}px)`;
}, { passive: false });

map.addEventListener("mousedown", e => { isDragging = true; start = { x: e.clientX, y: e.clientY }; });
window.addEventListener("mouseup", () => isDragging = false);
window.addEventListener("mousemove", e => {
  if (!isDragging) return;
  originX += (e.clientX - start.x) / scale;
  originY += (e.clientY - start.y) / scale;
  start = { x: e.clientX, y: e.clientY };
  map.style.transform = `scale(${scale}) translate(${originX}px, ${originY}px)`;
});

window.onload = () => render();
  </script>
</body>
</html>
